name: Claude Content Review

on:
  pull_request:
    paths:
      - '_posts/**'
      - '*.md'
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get changed files
      id: changed-files
      run: |
        echo "files<<EOF" >> $GITHUB_OUTPUT
        git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(md)$' || true
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Test API Key
      run: |
        echo "Testing API key availability..."
        if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
          echo "‚ùå API key is not set"
          exit 1
        else
          echo "‚úÖ API key is available"
        fi
        
        # Simple API test
        response=$(curl -s -X POST "https://api.anthropic.com/v1/messages" \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
          -H "anthropic-version: 2023-06-01" \
          -d '{
            "model": "claude-3-sonnet-20240229",
            "max_tokens": 100,
            "messages": [{
              "role": "user",
              "content": "Hello, this is a test. Please respond with just: API key works!"
            }]
          }')
        
        echo "API Response:"
        echo "$response"
        
        # Extract content from response
        review_content=$(echo "$response" | jq -r '.content[0].text // "Error: Could not get review from Claude"')
        
        # Comment on PR
        gh pr comment ${{ github.event.pull_request.number }} --body "## ü§ñ Claude API Test

        **Changed files:** ${{ steps.changed-files.outputs.files }}
        
        **API Response:** $review_content"
      env:
        GH_TOKEN: ${{ github.token }}